class DrawCharacterScreen{constructor(e){this.bind=createBinder(this),this.drawingSpace=new DrawSpace(640,480),window.addEventListener("mousedown",this.bind("mouseDown")),window.addEventListener("mouseup",this.bind("mouseUp")),window.addEventListener("mousemove",this.bind("mouseMove")),e.add(this.drawingSpace.createMesh())}destroy(){this.drawingSpace.destroy(),window.onmousedown=window.onmouseup=window.onmousemove=void 0}mouseDown(e){var a=screenToWorld(e.pageX,e.pageY);inside(a.toArray(),game.state.drawingSpace.canvasMesh.geometry.vertices.map(e=>e.toArray()))&&disableScroll(),this.drawingSpace.startDrawing(a.x,a.y)}mouseMove(e){var a=screenToWorld(e.pageX,e.pageY);this.drawingSpace.draw(a.x,a.y)}mouseUp(e){enableScroll();var a=screenToWorld(e.pageX,e.pageY);this.drawingSpace.stopDrawing(a.x,a.y)}async submitCharacter(){game.playerBlob=await this.drawingSpace.createBlob(),game.startGame()}}
class DrawSpace{constructor(e,t){this.stage=new createjs.Stage(document.createElement("canvas")),this.stage.canvas.width=e,this.stage.canvas.height=t,this.texture=new THREE.Texture(this.stage.canvas),this.geometry=this.geometry=new THREE.BoxGeometry(this.stage.canvas.width,this.stage.canvas.height,.1),this.material=new THREE.MeshBasicMaterial({map:this.texture,transparent:!0}),this.drawing=new createjs.Shape,this.stage.addChild(this.drawing),this.pen={color:"#ff00ff",size:10},this.stopDrawing(),this.stage.update(),this.texture.needsUpdate=!0}setSize(e,t){this.stage.canvas.width=t,this.stage.canvas.height=e}startDrawing(e,t){this.pen.active=!0,this.draw(e,t)}stopDrawing(e,t){!this.pen.moved&&e&&t&&this.draw(e,t),this.pen.active=!1,this.pen.moved=!1,this.pen.x=this.pen.y=null}draw(e,t){e=this.stage.canvas.width/2+e,t=this.stage.canvas.height/2-t,this.pen.active&&(this.pen.x&&(this.moved=!0,this.drawing.graphics.beginStroke(this.pen.color).setStrokeStyle(this.pen.size,"round").moveTo(this.pen.x||e,this.pen.y||t).lineTo(e,t),this.stage.update(),this.texture.needsUpdate=!0),this.pen.x=e,this.pen.y=t)}createMesh(){if(this.canvasMesh)return this.canvasMesh;var e=new THREE.Mesh(new THREE.BoxGeometry(this.stage.canvas.width,this.stage.canvas.height,1),new THREE.MeshBasicMaterial({color:"white"})),t=new THREE.Mesh(this.geometry,this.material);return e.add(t),t.position.set(0,0,e.scale.z/2+t.scale.z/2),this.drawingMesh=t,this.canvasMesh=e,e}async createBlob(){return new Promise((e,t)=>{this.stage.canvas.toBlob(e,"image/png",1)})}destroy(){this.stage.removeAllChildren(),this.stage.removeAllEventListeners(),this.stage._eventListeners=null,game.scene.remove(this.canvasMesh)}}
class Game{constructor(){this.bind=createBinder(this),this.touchHandler=new TouchHandler,this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.domElement),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,0,400),this.camera.lookAt(0,0,0);var e=new THREE.SpotLight(16777215);e.position.set(600,600,600),this.scene.add(e),window.addEventListener("onresize",this.bind("windowResize"))}startGame(){this.state&&this.state.destroy(),this.state=new WorldScreen,this.playerBlob&&this.state.addPlayer(0,"Player",this.playerBlob)}createCharacter(){this.state&&this.state.destroy(),this.state=new DrawCharacterScreen(this.scene)}submitCharacter(){game.state.submitCharacter()}windowResize(){var e=window.innerWidth,t=window.innerHeight;this.renderer&&(this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix())}screenToWorld(e,t,i=0){var r=new THREE.Vector3,n=new THREE.Vector3;r.set(e/window.innerWidth*2-1,-t/window.innerHeight*2+1,.5),r.unproject(this.camera),r.sub(this.camera.position).normalize();var s=(i-this.camera.position.z)/r.z;return n.copy(this.camera.position).add(r.multiplyScalar(s)),n}update(){requestAnimationFrame(this.bind("update")),this.renderer.render(this.scene,this.camera)}}
class Player{constructor(e,t,a){this.id=e,this.name=t;var n=new Image;n.src=URL.createObjectURL(a),window.document.body.appendChild(n);var s=new THREE.Texture;this.texture=s,n.onload=function(){s.image=n,s.needsUpdate=!0},this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100*n.width/n.height,100,.1),new THREE.MeshBasicMaterial({map:this.texture,transparent:!0}))}}
var keys={37:1,38:1,39:1,40:1};function preventDefault(e){e.preventDefault()}function preventDefaultForScrollKeys(e){if(keys[e.keyCode])return preventDefault(e),!1}var supportsPassive=!1;try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){supportsPassive=!0}}))}catch(e){}var wheelOpt=!!supportsPassive&&{passive:!1},wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel";function disableScroll(){window.addEventListener("DOMMouseScroll",preventDefault,!1),window.addEventListener(wheelEvent,preventDefault,wheelOpt),window.addEventListener("touchmove",preventDefault,wheelOpt),window.addEventListener("keydown",preventDefaultForScrollKeys,!1),console.log("Scroll Disabled")}function enableScroll(){window.removeEventListener("DOMMouseScroll",preventDefault,!1),window.removeEventListener(wheelEvent,preventDefault,wheelOpt),window.removeEventListener("touchmove",preventDefault,wheelOpt),window.removeEventListener("keydown",preventDefaultForScrollKeys,!1),console.log("ScrollEnabled")}
class TouchHandler{constructor(){this.bind=createBinder(this),window.addEventListener("touchstart",this.bind("touchStart")),window.addEventListener("touchmove",this.bind("touchMove")),window.addEventListener("touchcancel",this.bind("touchEnd")),window.addEventListener("touchend",this.bind("touchEnd")),this.lastTouches=[]}touchStart(o){Array(...o.touches).forEach(o=>{window.onmousedown&&window.onmousedown(o),window.dispatchEvent(new MouseEvent("mousedown",o))}),this.lastTouches=Array(...o.touches)}touchMove(o){Array(...o.touches).forEach(o=>{window.onmousedown&&window.onmousemove(o),window.dispatchEvent(new MouseEvent("mousemove",o))}),this.lastTouches=Array(...o.touches)}touchEnd(o){var t=Array(...o.touches);0==o.touches.length&&(t=this.lastTouches),t.forEach(o=>{window.onmousedown&&window.onmouseup(o),window.dispatchEvent(new MouseEvent("mouseup",o))}),this.lastTouches=Array(...o.touches)}}
function screenToWorld(n,e,r=0){var i=new THREE.Vector3,t=new THREE.Vector3;i.set(n/window.innerWidth*2-1,-e/window.innerHeight*2+1,.5),i.unproject(game.camera),i.sub(game.camera.position).normalize();var o=(r-game.camera.position.z)/i.z;return t.copy(game.camera.position).add(i.multiplyScalar(o)),t}function createBinder(n){return function(n,...e){return this[n].bind(this,...e)}.bind(n)}function blobFromBytes(n){return new Blob([n.buffer],{type:"image/png"})}function inside(n,e){for(var r=n[0],i=n[1],t=!1,o=0,a=e.length-1;o<e.length;a=o++){var c=e[o][0],u=e[o][1],m=e[a][0],d=e[a][1];u>i!=d>i&&r<(m-c)*(i-u)/(d-u)+c&&(t=!t)}return t}
class WorldScreen{constructor(){this.players={}}addPlayer(r,s,e){if(!this.players[r])return this.players[r]=new Player(r,s,e),this.players[r]}destroy(){}}
//# sourceMappingURL=game.min.js.map
